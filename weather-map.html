<!DOCTYPE html>
<html lang="en">
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="Codeup Weather Map Project" content="Interactive weather map providing a 5-day forecast">
    <meta name="author" content="Joseph McComas">
    <script src='https://api.mapbox.com/mapbox-gl-js/v2.12.0/mapbox-gl.js'></script>
    <link href='https://api.mapbox.com/mapbox-gl-js/v2.12.0/mapbox-gl.css' rel='stylesheet'/>
    <link rel="stylesheet" href="css/stylesheet.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Exo+2:wght@200&family=Space+Grotesk&display=swap');
    </style>
    <meta charset="UTF-8">
    <title>Epic Weather Map</title>
</head>
<body>
<script src="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v5.0.0/mapbox-gl-geocoder.min.js"></script>
<link rel="stylesheet"
      href="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v5.0.0/mapbox-gl-geocoder.css"
      type="text/css">
<script src="https://code.jquery.com/jquery-3.6.3.js" integrity="sha256-nQLuAZGRRcILA+6dMBOvcRh5Pe310sBpanc6+QBmyVM="
        crossorigin="anonymous"></script>
<!--<script src="js/mapbox-geocoder-utils.js"></script>-->
<script src="js/keys.js"></script>

<!-- PAGE START -->


<div class="main">
    <div class="h-container">
        <div class="header">
            <h1>
            </h1>
        </div>
    </div>
    <div class="container">
        <div class="app twelve columns">
            <div class="twelve columns">
                <div>
                    <h1 class="four columns headline">World's Most Epic Weather Map <span class="location"></span></h1>
                </div>
                <div class="search-weather eight columns">
                    <h3>Find a Forecast</h3>
                    <form id="my-form" action="">
                        <input type="search" placeholder="Search for location or keyword" class="find-forecast">
                        <button class="search-btn">Search</button>
                    </form>
                </div>
            </div>
            <div class="twelve columns">
                <div class="four columns">
                    <div class="weather-info">
                        <div class="weather-info-animation">
                            <canvas id="animated-icon" width="220" height="220"></canvas>
                        </div>
                        <div class="four columns">
                            <div id="my-map" style="width: 800px; height: 600px;"></div>
                        </div>

                    </div>
                </div>
                <div class="seven columns offset-by-one">
                    <div class="weather-info-text">
                        <div class="one-third column">
                            <span class="local-time">~~:~~</span>
                        </div>
                        <div class="one-third column">
                            <div class="temperature">
                                <span class="temp-celsius hidden">°C</span>
                                <span class="temp-fahrenheit">F</span>
                            </div>
                        </div>
                        <div class="one-third column">
                            <span class="weather-condition">~~~</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>  <!-- app -->
    </div> <!-- container -->
</div> <!-- main -->

<!--<layer id="layer1">-->
<!--    <div class="loader-anim">-->
<!--        <h1>Loading Map</h1>-->
<!--        <div class='loader' id="sc-loader"></div>-->
<!--    </div>-->
<!--</layer>-->
<!--<layer id="layer2">-->
<!--<div class="container-fluid">-->

<!--    <div class="form-group">-->
<!--        <label for="address-input" class="form-label"></label>-->
<!--        <input id="address-input" class="form-input" type="text" placeholder="Enter an address">-->
<!--        <button id="search-btn" onClick="addLayerSpinner()">Search</button>-->
<!--    </div>-->
<!--    <div class="map-container">-->
<!--        <div id="my-map" style="width: 800px; height: 600px;"></div>-->
<!--</div>-->
<!--</layer>-->
<!--</div>-->

<script>
    "use strict"

    $(document).ready(function () {
        mapboxgl.accessToken = MAPBOX_API_KEY;
        const map = new mapboxgl.Map({
            container: 'my-map',
            style: 'mapbox://styles/mapbox/satellite-streets-v12',
            center: [-98.4946, 29.4252],
            zoom: 12,
            marker: false,
        });
        const geocoder = new MapboxGeocoder({
            accessToken: MAPBOX_API_KEY, // Set the access token
            mapboxgl: mapboxgl, // Set the mapbox-gl instance
            marker: false, // Do not use the default marker style
            placeholder: 'Search', // Placeholder text for the search bar
        });
        // map.addControl(geocoder);
        map.addControl(new mapboxgl.NavigationControl());
        map.on('load', () => {
            map.addSource('single-point', {
                'type': 'geojson',
                'data': {
                    'type': 'FeatureCollection',
                    'features': []
                }
            });
            map.addLayer({
                'id': 'point',
                'source': 'single-point',
                'type': 'circle',
                'paint': {
                    'circle-radius': 10,
                    'circle-color': '#448ee4'
                }
            });
            geocoder.on("result", (event) => {
                map.getSource("single-point").setData(event.result.geometry);
            });
        });

        // START WEATHER

        let longitude, latitude, timeHour, timeFull;

        // START Google Maps API

        const settings = {
            "async": true,
            "crossDomain": true,
            "url": "https://google-maps-geocoding.p.rapidapi.com/geocode/json?address=san%20antonio%2C%20TX&language=en",
            "method": "GET",
            "headers": {
                "X-RapidAPI-Key": GOOGLE_MAPS_API_KEY,
                "X-RapidAPI-Host": "https://google-maps-geocoding.p.rapidapi.com"
            }
        };

        // END Google Maps API

        $.ajax(settings).done(function (response) {
            console.log(response);
        });
        function geocode(search, token) {
            let baseUrl = 'https://google-maps-geocoding.p.rapidapi.com/';
            let endPoint = '/geocode/';
            return fetch(baseUrl + endPoint + '.json' + "?" +  encodeURIComponent(search) + "language=en")
                .then(function (res) {
                    return res.json();
                }).then(function (data) {
                    return data.features;
                });
        }

        geocode();
        const updateWeather = () => {
            longitude = json.coord.longitude;
            latitude = json.coord.latitude;
            $.getJSON('https://api.weather.gov/points/' + {latitude}, +{longitude}, function (timezone) {
                let rawTimeZone = JSON.stringify(timezone);
                let parsedTimeZone = JSON.parse(rawTimeZone);
                let dateTime = parsedTimeZone.time;
                timeFull = dateTime.substr(11);
                $(".local-time").html(timeFull); //Update local time
                timeHour = dateTime.substr(-5, 2);
            });
            updateWeather(json);
            $(".weather-condition").html(json.weather[0].description);
            let temp = [(json.main.temp - 273.15).toFixed(0) + "°C", (1.8 * (json.main.temp - 273.15) + 32).toFixed(0) + "F"];
            $(".temp-celsius").html(temp[0]);
            $(".temp-fahrenheit").html(temp[1]);
            $(".temperature").click(function () {
                $(".temp-celsius").toggle();
                $(".temp-fahrenheit").toggle();
            });
            $(".location").html("for " + json.name);
            if (navigator.geolocation) {
                window.onload = function () {
                    let currentPosition;

                    function getCurrentLocation(position) {
                        currentPosition = position;
                        latitude = currentPosition.coords.latitude;
                        longitude = currentPosition.coords.longitude;
                        $.getJSON("https://api.weather.gov/openapi.json" + latitude + "&lon=" + longitude, function (data) {
                            let rawJson = JSON.stringify(data);
                            let json = JSON.parse(rawJson);
                            updateWeather(json); //Update Weather parameters
                        });
                    }

                    navigator.geolocation.getCurrentPosition(getCurrentLocation);
                };
            } else {
                alert("Geolocation is not supported by your browser, download the latest Chrome or Firefox to use this app");
            }
            $("form").on("submit", function (event) {
                event.preventDefault();
                let city = $(".find-forecast").val(); //Get value from form input
                document.getElementById("my-form").reset();
                $.getJSON("https://api.weather.gov/openapi.json" + latitude + "&lon=" + longitude, function (data) {
                    let rawJson = JSON.stringify(data);
                    let json = JSON.parse(rawJson);
                    updateWeather(json); //Update Weather parameters
                });
            });

            // END WEATHER

            // START wIcons

            const rain = import("img/rain.svg");
            const clearDay = import("img/clear-day.svg");
            const clearNight = import("img/clear-night.svg");
            const partlyCloudyDay = import("img/partly-cloudy-day.svg");
            const partlyCloudyNight = import("img/partly-cloudy-night.svg");
            const snow = import("img/snow.svg");
            const thunderstorm = import("img/thunderstorm.svg")

            let wIcons = new wIcons({"color": "#FFFAFF"});

            wIcons.add("animated-icon", clearDay);

            wIcons.play();

            let weather = json.weather[0].description;

            if (weather.indexOf("rain") >= 0) {
                wIcons.set("animated-icon", rain);
            } else if (weather.indexOf("sunny") >= 0) {
                wIcons.set("animated-icon", clearDay);
            } else if (weather.indexOf("clear") >= 0) {
                if (timeHour >= 7 && timeHour < 20) {
                    wIcons.set("animated-icon", clearDay);
                } else {
                    wIcons.set("animated-icon", clearNight);
                }
            } else if (weather.indexOf("cloud") >= 0) {
                if (timeHour >= 7 && timeHour < 20) {
                    wIcons.set("animated-icon", partlyCloudyDay);
                } else {
                    wIcons.set("animated-icon", partlyCloudyNight);
                }
            } else if (weather.indexOf("thunderstorm") >= 0) {
                wIcons.set("animated-icon", thunderstorm);
            } else if (weather.indexOf("snow") >= 0) {
                wIcons.set("animated-icon", snow);
            }
        };
        // END wIcons
    });
</script>
</body>
</html>

<!--NOTES
https://api.weather.gov/points/{lat},{lon}
mapbox://styles/mapbox/satellite-v9

-->
